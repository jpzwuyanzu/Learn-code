import { Link, useLocation, useNavigate, Outlet, useAppData, matchRoutes } from "umi";
import React, { useMemo } from "react";
import {
  ProLayout
} from "/Users/xinyonghu/Desktop/personalCode/pay-manager-web/node_modules/@ant-design/pro-components";
import "./Layout.less";
import Logo from "./Logo";
import Exception from "./Exception";
import { getRightRenderContent } from "./rightRender";
import { useModel } from "@@/plugin-model";
import { useAccessMarkedRoutes } from "@@/plugin-access";
const filterRoutes = (routes, filterFn) => {
  if (routes.length === 0) {
    return [];
  }
  let newRoutes = [];
  for (const route of routes) {
    const newRoute = { ...route };
    if (filterFn(route)) {
      if (Array.isArray(newRoute.routes)) {
        newRoutes.push(...filterRoutes(newRoute.routes, filterFn));
      }
    } else {
      if (Array.isArray(newRoute.children)) {
        newRoute.children = filterRoutes(newRoute.children, filterFn);
        newRoute.routes = newRoute.children;
      }
      newRoutes.push(newRoute);
    }
  }
  return newRoutes;
};
const mapRoutes = (routes) => {
  if (routes.length === 0) {
    return [];
  }
  return routes.map((route) => {
    const newRoute = { ...route };
    if (route.originPath) {
      newRoute.path = route.originPath;
    }
    if (Array.isArray(route.routes)) {
      newRoute.routes = mapRoutes(route.routes);
    }
    if (Array.isArray(route.children)) {
      newRoute.children = mapRoutes(route.children);
    }
    return newRoute;
  });
};
export default (props) => {
  const location = useLocation();
  const navigate = useNavigate();
  const { clientRoutes, pluginManager } = useAppData();
  const initialInfo = useModel && useModel("@@initialState") || {
    initialState: void 0,
    loading: false,
    setInitialState: null
  };
  const { initialState, loading, setInitialState } = initialInfo;
  const userConfig = {};
  const formatMessage = void 0;
  const runtimeConfig = pluginManager.applyPlugins({
    key: "layout",
    type: "modify",
    initialValue: {
      ...initialInfo
    }
  });
  const newRoutes = filterRoutes(clientRoutes.filter((route2) => route2.id === "ant-design-pro-layout"), (route2) => {
    return !!route2.isLayout && route2.id !== "ant-design-pro-layout" || !!route2.isWrapper;
  });
  const [route] = useAccessMarkedRoutes(mapRoutes(newRoutes));
  const matchedRoute = useMemo(() => matchRoutes(route.children, location.pathname)?.pop?.()?.route, [location.pathname]);
  return /* @__PURE__ */ React.createElement(
    ProLayout,
    {
      route,
      location,
      title: userConfig.title || "plugin-layout",
      navTheme: "dark",
      siderWidth: 256,
      onMenuHeaderClick: (e) => {
        e.stopPropagation();
        e.preventDefault();
        navigate("/");
      },
      formatMessage: userConfig.formatMessage || formatMessage,
      menu: { locale: userConfig.locale },
      logo: Logo,
      menuItemRender: (menuItemProps, defaultDom) => {
        if (menuItemProps.isUrl || menuItemProps.children) {
          return defaultDom;
        }
        if (menuItemProps.path && location.pathname !== menuItemProps.path) {
          return (
            // handle wildcard route path, for example /slave/* from qiankun
            /* @__PURE__ */ React.createElement(Link, { to: menuItemProps.path.replace("/*", ""), target: menuItemProps.target }, defaultDom)
          );
        }
        return defaultDom;
      },
      itemRender: (route2) => /* @__PURE__ */ React.createElement(Link, { to: route2.path }, route2.breadcrumbName),
      disableContentMargin: true,
      fixSiderbar: true,
      fixedHeader: true,
      ...runtimeConfig,
      rightContentRender: runtimeConfig.rightContentRender !== false && ((layoutProps) => {
        const dom = getRightRenderContent({
          runtimeConfig,
          loading,
          initialState,
          setInitialState
        });
        if (runtimeConfig.rightContentRender) {
          return runtimeConfig.rightContentRender(layoutProps, dom, {
            // BREAK CHANGE userConfig > runtimeConfig
            userConfig,
            runtimeConfig,
            loading,
            initialState,
            setInitialState
          });
        }
        return dom;
      })
    },
    /* @__PURE__ */ React.createElement(
      Exception,
      {
        route: matchedRoute,
        noFound: runtimeConfig?.noFound,
        notFound: runtimeConfig?.notFound,
        unAccessible: runtimeConfig?.unAccessible,
        noAccessible: runtimeConfig?.noAccessible
      },
      runtimeConfig.childrenRender ? runtimeConfig.childrenRender(/* @__PURE__ */ React.createElement(Outlet, null), props) : /* @__PURE__ */ React.createElement(Outlet, null)
    )
  );
};
