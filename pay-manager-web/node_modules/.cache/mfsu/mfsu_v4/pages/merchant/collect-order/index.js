import TablePage from "@/components/TablePage";
import services from "@/services";
import { Spin, Statistic, message } from "antd";
import { LoadingOutlined } from "@ant-design/icons";
import {
  APP_IS_PAYMENT,
  CallbackStatusOptions,
  IS_TEST,
  PayStatusOptions
} from "@/constants";
import { useRef, useState } from "react";
import { useModel } from "umi";
import common from "@/utils/common";
import Status from "@/components/Status";
import ChangeOrderStatus from "@/components/ChangeOrderStatus";
import utils from "@/utils";
export default () => {
  const tabRef = useRef();
  const tableRef = useRef();
  const { getMerchantOptionItems, getCurrencyOptionItems } = useModel("global");
  const { merchantInfo } = useModel("merchant");
  const [statisticData, setStatisticData] = useState({
    collectionCount: "",
    settlementAmount: "",
    successAmount: "",
    successCount: "",
    successRate: ""
  });
  const [refreshLoadingMap, setRefreshLoadingMap] = useState({});
  const listRequest = async (params, sort, filter) => {
    const { records, data, total } = await services.merchant.collectOrder.list(utils.filterParams(params));
    setStatisticData(data);
    return {
      success: true,
      data: records,
      total
    };
  };
  const refresh = async (record) => {
    try {
      if (refreshLoadingMap?.[record?.id])
        return;
      setRefreshLoadingMap({
        ...refreshLoadingMap,
        [record.id]: true
      });
      const { platformOrderId, merchantId } = record;
      const params = {
        merchantId,
        platformOrderId
      };
      await services.merchant.collectOrder.refresh(params);
      const rowData = await services.merchant.collectOrder.queryOrder(params);
      tabRef?.current?.updateRow(rowData);
      message.success("\u5237\u65B0\u6210\u529F");
    } finally {
      setRefreshLoadingMap({
        ...refreshLoadingMap,
        [record.id]: false
      });
    }
  };
  const orderCallback = async (record) => {
    const { platformOrderId, merchantId } = record;
    await services.merchant.collectOrder.callback({
      platformOrderId,
      merchantId
    });
    message.success("\u56DE\u8C03\u6210\u529F");
    tableRef.current?.reload();
  };
  const columns = [
    {
      title: "\u901A\u9053ID",
      dataIndex: "tunnelId",
      valueType: "select",
      request: () => {
        const params = { type: 1 };
        if (!APP_IS_PAYMENT) {
          params["merchantId"] = merchantInfo.merchantId;
        }
        return services.channel.getTunnelOptions(params);
      },
      hideInTable: true,
      hideInForm: true
    },
    {
      title: "\u5546\u6237\u53F7",
      dataIndex: "merchantId",
      hideInSearch: !APP_IS_PAYMENT
    },
    {
      title: "\u8BA2\u5355\u53F7",
      dataIndex: "orderId",
      hideInSearch: true,
      width: 260,
      ellipsis: true,
      render: (_, record) => /* @__PURE__ */ React.createElement("div", { className: "text-left" }, /* @__PURE__ */ React.createElement("div", null, "\u5E73\u53F0\uFF1A", record?.platformOrderId), /* @__PURE__ */ React.createElement("div", null, "\u5546\u6237\uFF1A", record?.merchantOrderId), /* @__PURE__ */ React.createElement("div", null, "\u901A\u9053\uFF1A", record?.tunnelOrderId), /* @__PURE__ */ React.createElement("div", null, "UTR\uFF1A"))
    },
    {
      title: "\u5E73\u53F0\u8BA2\u5355\u53F7",
      dataIndex: "platformOrderId",
      hideInTable: true,
      fieldProps: (form) => {
        return {
          onChange: (e) => {
            const value = e.target.value;
            if (value?.length) {
              form?.setFieldValue?.(
                "initiateTime",
                common.dateUtils.getDateRange(30)
              );
            }
          }
        };
      }
    },
    {
      title: "\u5546\u6237\u8BA2\u5355\u53F7",
      dataIndex: "merchantOrderId",
      hideInTable: true,
      fieldProps: (form) => {
        return {
          onChange: (e) => {
            const value = e.target.value;
            if (value?.length) {
              form?.setFieldValue?.(
                "initiateTime",
                common.dateUtils.getDateRange(30)
              );
            }
          }
        };
      }
    },
    {
      title: "UTR",
      dataIndex: "utr",
      hideInTable: true
    },
    {
      title: "\u901A\u9053\u4FE1\u606F",
      dataIndex: "channel",
      hideInSearch: true,
      width: 180,
      ellipsis: true,
      render: (_, record) => /* @__PURE__ */ React.createElement("div", { className: "text-left" }, /* @__PURE__ */ React.createElement("div", null, "\u8D26\u53F7ID\uFF1A", record?.tunnelId))
    },
    {
      title: "\u8BA2\u5355\u91D1\u989D",
      dataIndex: "amount",
      valueType: "digitRange",
      fieldProps: {
        placeholder: ["\u6700\u5C0F\u91D1\u989D", "\u6700\u5927\u91D1\u989D"]
      },
      search: {
        transform: (value) => {
          return {
            startAmount: value?.[0],
            endAmount: value?.[1]
          };
        }
      },
      render: (_, record) => record?.amount
    },
    {
      title: "\u624B\u7EED\u8D39",
      dataIndex: "fee",
      hideInSearch: true
    },
    {
      title: "\u7ED3\u7B97\u91D1\u989D",
      dataIndex: "settlementAmount",
      hideInSearch: true
    },
    {
      title: "\u72B6\u6001",
      dataIndex: "status",
      hideInSearch: true,
      render: (_, record) => /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement("div", null, "\u652F\u4ED8\uFF1A", /* @__PURE__ */ React.createElement(Status, { type: "pay", val: record?.payStatus })), /* @__PURE__ */ React.createElement("div", null, "\u56DE\u8C03\uFF1A", /* @__PURE__ */ React.createElement(Status, { type: "callback", val: record?.callbackStatus })))
    },
    {
      title: "\u652F\u4ED8\u72B6\u6001",
      dataIndex: "payStatus",
      valueType: "select",
      request: async () => [{ label: "\u5168\u90E8", value: "" }, ...PayStatusOptions],
      hideInTable: true
    },
    {
      title: "\u56DE\u8C03\u72B6\u6001",
      dataIndex: "callbackStatus",
      valueType: "select",
      request: async () => [
        { label: "\u5168\u90E8", value: "" },
        ...CallbackStatusOptions
      ],
      hideInTable: true
    },
    {
      title: "\u53D1\u8D77\u65F6\u95F4",
      dataIndex: "initiateTime",
      valueType: "dateTimeRange",
      initialValue: common.dateUtils.getDateRange(1),
      width: 150,
      fieldProps: (form) => {
        return {
          placeholder: ["\u5F00\u59CB\u65F6\u95F4", "\u7ED3\u675F\u65F6\u95F4"],
          allowClear: false,
          presets: common.dateUtils.rangePresets,
          showTime: {
            defaultValue: common.dateUtils.rangeDefaultTime()
          }
        };
      },
      formItemProps: {
        rules: [
          {
            required: true
          }
        ]
      },
      search: {
        transform: (value) => {
          return {
            beginTime: value?.[0],
            endTime: value?.[1]
          };
        }
      },
      render: (_, record) => record?.createTime,
      colSize: 1.2
    },
    {
      title: "\u5B8C\u6210\u65F6\u95F4",
      dataIndex: "completeTime",
      valueType: "dateTimeRange",
      fieldProps: (form) => {
        return {
          placeholder: ["\u5F00\u59CB\u65F6\u95F4", "\u7ED3\u675F\u65F6\u95F4"],
          allowClear: false,
          presets: common.dateUtils.rangePresets,
          showTime: {
            defaultValue: common.dateUtils.rangeDefaultTime()
          }
        };
      },
      search: {
        transform: (value) => {
          return {
            finishBeginTime: value?.[0],
            finishEndTime: value?.[1]
          };
        }
      },
      colSize: 1.5,
      hideInTable: true
    },
    {
      title: "\u56DE\u8C03\u65F6\u95F4",
      width: 150,
      dataIndex: "callbackTime",
      hideInSearch: true
    }
    // {
    //   title: '币种',
    //   dataIndex: 'currency',
    //   valueType: 'select',
    //   request: () => getCurrencyOptionItems(),
    //   fieldProps: {
    //     defaultValue: '',
    //   },
    //   order: 1,
    // },
  ];
  return /* @__PURE__ */ React.createElement(React.Fragment, null, /* @__PURE__ */ React.createElement(
    TablePage,
    {
      ref: tabRef,
      tableRef,
      moduleTitle: "\u4EE3\u6536\u8BA2\u5355",
      columns,
      listRequest,
      exportRequest: services.merchant.collectOrder.export,
      scroll: { x: 1800 },
      actionsWidth: 200,
      actions: (record) => [
        /* @__PURE__ */ React.createElement(
          "a",
          {
            key: "refresh",
            className: refreshLoadingMap?.[record?.id] ? "loading" : "",
            onClick: () => refresh(record)
          },
          refreshLoadingMap?.[record?.id] ? /* @__PURE__ */ React.createElement(Spin, { indicator: /* @__PURE__ */ React.createElement(LoadingOutlined, { size: 12 }), size: "small" }) : "\u5237\u65B0"
        ),
        APP_IS_PAYMENT && record?.callbackStatus !== 1 && /* @__PURE__ */ React.createElement(
          "a",
          {
            key: "callback",
            className: "text-orange",
            onClick: () => orderCallback(record)
          },
          "\u56DE\u8C03"
        ),
        IS_TEST && record?.payStatus === 0 && /* @__PURE__ */ React.createElement(
          ChangeOrderStatus,
          {
            key: "changeOrderStatus",
            record,
            reload: tableRef?.current?.reload,
            request: services.merchant.collectOrder.updatePayStatus
          }
        )
      ],
      footer: () => /* @__PURE__ */ React.createElement("div", { className: "footer-statistic" }, /* @__PURE__ */ React.createElement("div", { className: "row" }, /* @__PURE__ */ React.createElement(
        Statistic,
        {
          title: "\u4EE3\u6536\u6B21\u6570",
          value: statisticData?.collectionCount || 0
        }
      ), /* @__PURE__ */ React.createElement(
        Statistic,
        {
          title: "\u6210\u529F\u6B21\u6570",
          value: statisticData?.successCount || 0
        }
      ), /* @__PURE__ */ React.createElement(
        Statistic,
        {
          title: "\u6210\u529F\u603B\u91D1\u989D",
          value: statisticData?.successAmount || 0
        }
      ), /* @__PURE__ */ React.createElement(
        Statistic,
        {
          title: "\u6210\u529F\u7387",
          value: statisticData?.successRate || 0,
          suffix: "%"
        }
      ), /* @__PURE__ */ React.createElement(
        Statistic,
        {
          title: "\u6210\u529F\u603B\u7ED3\u7B97\u91D1\u989D",
          value: statisticData?.settlementAmount || 0
        }
      )))
    }
  ));
};
